name: Sentiment CI/CD

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: "3.9"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    
    - name: Run Unit Tests
      run: python test_app.py
    
    - name: Validate Model Loading
      run: |
        python -c "
        from app import SentimentAnalyzer
        analyzer = SentimentAnalyzer()
        result = analyzer.predict('Test validation')
        assert 'sentiment' in result
        print('Model validation passed!')
        "

  deploy-to-huggingface:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.9"
    
    - name: Install huggingface_hub
      run: pip install huggingface_hub
    
    - name: Deploy to HuggingFace Spaces
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
      run: |
        python << 'EOF'
        from huggingface_hub import HfApi
        api = HfApi()
        api.upload_folder(
            folder_path=".",
            repo_id="celli77777/sentiment_Analysis",
            repo_type="space",
            token="${{ secrets.HF_TOKEN }}"
        )
        print("Deployed to HuggingFace!")
        EOF
